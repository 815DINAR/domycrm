<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domyland Tools</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="image/logo.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/products.css">
</head>
<body>
    <div class="app-container">
        <!-- Боковая панель навигации -->
        <aside class="navigation-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Domyland Tools</h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-item active" data-section="calculator">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="4" width="20" height="16" rx="2"/>
                            <path d="M8 9h8"/>
                            <path d="M8 13h6"/>
                            <path d="M8 17h4"/>
                        </svg>
                        <span>Калькулятор стоимости</span>
                    </div>
                    
                    <!-- Админ панель - скрыта по умолчанию -->
                    <div class="nav-item admin-only" data-section="admin" style="display: none;">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>Настройки</span>
                    </div>
                    
                    <!-- Раздел Продукты - только для админов -->
                    <div class="nav-item admin-only" data-section="products" style="display: none;">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                            <line x1="7" y1="7" x2="7.01" y2="7"/>
                        </svg>
                        <span>Продукты</span>
                    </div>
                </div>
                
                <!-- Кнопка выхода внизу меню -->
                <div class="nav-section" style="margin-top: auto; padding-bottom: 20px;">
                    <div class="nav-item" id="logoutBtn">
                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Выход</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Секция калькулятора -->
            <div id="calculator-section" class="content-section active">
                <div class="container">
                    <header>
                        <h1>Калькулятор стоимости продуктов</h1>
                        <a href="https://cypress-lantana-0e0.notion.site/22332fd3ba2d80efa0afc3a220c28ca2?source=copy_link" class="instruction-btn">Инструкция</a>
                    </header>

                    <div class="main-form">
                        <div class="form-group">
                            <label for="calculatorType">Выбор калькулятора:</label>
                            <select id="calculatorType" required>
                                <option value="increase">Увеличение помещений</option>
                                <option value="new">Новая сделка/Пролонг</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="tariffSelect">Тариф:</label>
                            <select id="tariffSelect" required>
                                <option value="">Загрузка тарифов...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="propertyType">Тип недвижимости:</label>
                            <select id="propertyType" required>
                                <option value="">Выберите тип</option>
                                <option value="многоквартирный дом">Многоквартирный дом</option>
                                <option value="коттеджный поселок">Коттеджный поселок</option>
                            </select>
                        </div>

                        <div class="form-group increase-fields">
                            <label for="currentUnits">Текущее количество помещений у партнера:</label>
                            <input type="number" id="currentUnits" min="0" placeholder="Введите количество" required>
                        </div>

                        <div class="form-group increase-fields">
                            <label for="globalUnits">Сколько нужно добавить помещений:</label>
                            <input type="number" id="globalUnits" min="1" placeholder="Введите количество" required>
                        </div>

                        <div class="form-group new-deal-fields" style="display: none;">
                            <label for="totalUnits">Помещений (лицевых счетов):</label>
                            <input type="number" id="totalUnits" min="1" placeholder="Введите количество" required>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="globalUnitsEnabled" checked>
                                <span class="checkmark"></span>
                                Одинаковое количество помещений для всех продуктов
                                <span class="info-icon" data-tooltip="Если включено - количество помещений будет одинаковым для всех выбранных продуктов. Если выключено - можно указать индивидуальное количество для каждого продукта.">ℹ️</span>
                            </label>
                        </div>

                        <div class="form-group date-group">
                            <div>
                                <label for="dateFrom">Дата ОТ:</label>
                                <input type="date" id="dateFrom" class="date-input-manual" required>
                            </div>
                            <div>
                                <label for="dateTo">Дата ДО:</label>
                                <input type="date" id="dateTo" class="date-input-manual" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="globalDates" checked>
                                <span class="checkmark"></span>
                                Одинаковая дата для всех продуктов
                                <span class="info-icon" data-tooltip="Если включено - все продукты будут подключены на один период времени. Если выключено - можно указать индивидуальные даты начала и окончания для каждого продукта.">ℹ️</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="globalDiscount">Скидка (%)( Необязательно для заполнения):</label>
                            <input type="number" id="globalDiscount" min="0" max="100" step="0.01" placeholder="Введите скидку">
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="globalDiscounts" checked>
                                <span class="checkmark"></span>
                                Одинаковая скидка на все продукты
                                <span class="info-icon" data-tooltip="Если включено - одинаковая скидка применится ко всем продуктам. Если выключено - можно указать индивидуальную скидку для каждого продукта или оставить без скидки.">ℹ️</span>
                            </label>
                        </div>

                        <div class="products-section">
                            <h3>Выбор продуктов</h3>
                            <div class="products-categories" id="productsCategories"></div>
                            <button type="button" id="addSelectedProducts" class="btn-primary">Добавить выбранные продукты</button>
                            <div id="productsList" class="added-products-list"></div>
                        </div>

                        <button type="button" id="calculate" class="btn-primary">Рассчитать стоимость</button>
                    </div>

                    <div id="results" class="results-section" style="display: none;">
                        <h3>Результаты расчета</h3>
                        <div id="resultsContent"></div>
                        <div id="totalCost" class="total-cost"></div>
                        
                        <!-- Поле для копирования итогового текста -->
                        <div class="summary-section">
                            <h4>Итоговый текст для треда в mm</h4>
                            <textarea id="summaryText" class="summary-textarea" readonly></textarea>
                            <button id="copySummary" class="btn-secondary">Копировать текст</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция админ панели -->
            <div id="admin-section" class="content-section" style="display: none;">
                <div class="container">
                    <header>
                        <h1>Панель администратора</h1>
                    </header>

                    <div class="admin-tabs">
                        <button class="admin-tab active" data-tab="pending">Ожидающие одобрения</button>
                        <button class="admin-tab" data-tab="users">Все пользователи</button>
                        <button class="admin-tab" data-tab="preapproved">Предодобренные email</button>
                    </div>

                    <div class="admin-content">
                        <!-- Вкладка ожидающих одобрения -->
                        <div id="pending-tab" class="admin-tab-content active">
                            <h3>Пользователи, ожидающие одобрения</h3>
                            <div id="pendingUsersList" class="users-list">
                                <p>Загрузка...</p>
                            </div>
                        </div>

                        <!-- Вкладка всех пользователей -->
                        <div id="users-tab" class="admin-tab-content" style="display: none;">
                            <h3>Все пользователи</h3>
                            <div class="users-filter">
                                <input type="text" id="userSearch" placeholder="Поиск по email или имени">
                                <select id="statusFilter">
                                    <option value="">Все статусы</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="pending">Ожидающие</option>
                                    <option value="rejected">Отклоненные</option>
                                </select>
                            </div>
                            <div id="allUsersList" class="users-list">
                                <p>Загрузка...</p>
                            </div>
                        </div>

                        <!-- Вкладка предодобренных email -->
                        <div id="preapproved-tab" class="admin-tab-content" style="display: none;">
                            <h3>Предодобренные email адреса</h3>
                            <div class="add-email-form">
                                <input type="email" id="newPreapprovedEmail" placeholder="email@example.com">
                                <button id="addPreapprovedBtn" class="btn-primary">Добавить</button>
                            </div>
                            <div id="preapprovedList" class="users-list">
                                <p>Загрузка...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция управления продуктами (тарифами) - только для админов -->
            <div id="products-section" class="content-section" style="display: none;">
                <div class="container">
                    <header>
                        <h1>Управление тарифами и продуктами</h1>
                    </header>

                    <div class="tariffs-header">
                        <select id="tariffSelector" class="tariff-selector">
                            <option value="">Выберите тариф для редактирования</option>
                        </select>
                        <div class="tariff-actions">
                            <button id="createTariffBtn" class="btn-primary">Создать новый тариф</button>
                            <button id="copyTariffBtn" class="btn-secondary" disabled>Копировать тариф</button>
                            <button id="setDefaultBtn" class="btn-secondary" disabled>Сделать по умолчанию</button>
                            <button id="deleteTariffBtn" class="btn-delete" disabled>Удалить тариф</button>
                        </div>
                    </div>

                    <div id="tariffEditor" class="tariff-editor" style="display: none;">
                        <div class="tariff-info">
                            <div class="form-group">
                                <label for="tariffName">Название тарифа:</label>
                                <input type="text" id="tariffName" placeholder="Например: Тариф 2025">
                            </div>
                            <div class="form-group">
                                <label for="tariffYear">Год:</label>
                                <input type="number" id="tariffYear" min="2020" max="2030" placeholder="2025">
                            </div>
                            <button id="saveTariffInfo" class="btn-primary">Сохранить информацию о тарифе</button>
                        </div>

                        <div class="categories-section">
                            <h3>Категории и продукты</h3>
                            <div id="categoriesList" class="categories-list">
                                <!-- Здесь будут отображаться категории и продукты -->
                            </div>
                            <button id="addCategoryBtn" class="btn-primary">Добавить категорию</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальные окна для управления продуктами -->
    <!-- Модальное окно добавления/редактирования категории -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="categoryModalTitle">Добавить категорию</h3>
            <div class="form-group">
                <label for="categoryName">Название категории:</label>
                <input type="text" id="categoryName" placeholder="Например: Сервисы ЖКХ">
            </div>
            <div class="modal-buttons">
                <button id="saveCategoryBtn" class="btn-primary">Сохранить</button>
                <button id="cancelCategoryBtn" class="btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования продукта -->
    <div id="productModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <span class="close">&times;</span>
            <h3 id="productModalTitle">Добавить продукт</h3>
            <div class="form-group">
                <label for="productName">Название продукта:</label>
                <input type="text" id="productName" placeholder="Например: Аварийно-диспетчерская служба">
            </div>
            
            <div class="property-types-tabs">
                <button class="property-tab active" data-property="многоквартирный дом">Многоквартирный дом</button>
                <button class="property-tab" data-property="коттеджный поселок">Коттеджный поселок</button>
                <button class="property-tab" data-property="фиксированная цена">Фиксированная цена</button>
            </div>

            <div id="priceRangesContainer" class="price-ranges-container">
                <!-- Здесь будут диапазоны цен -->
            </div>

            <button id="addRangeBtn" class="btn-secondary">Добавить диапазон</button>
            
            <div class="modal-buttons">
                <button id="saveProductBtn" class="btn-primary">Сохранить продукт</button>
                <button id="cancelProductBtn" class="btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания нового тарифа -->
    <div id="newTariffModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Создать новый тариф</h3>
            <div class="form-group">
                <label for="newTariffName">Название тарифа:</label>
                <input type="text" id="newTariffName" placeholder="Например: Тариф 2026">
            </div>
            <div class="form-group">
                <label for="newTariffYear">Год:</label>
                <input type="number" id="newTariffYear" min="2020" max="2030" placeholder="2026">
            </div>
            <div class="form-group">
                <label for="copyFromTariff">Копировать из тарифа (опционально):</label>
                <select id="copyFromTariff">
                    <option value="">Создать пустой тариф</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="createNewTariffBtn" class="btn-primary">Создать</button>
                <button id="cancelNewTariffBtn" class="btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Скрипт проверки авторизации -->
    <script>
        // Глобальные переменные для тарифов
        window.currentTariff = null;
        window.availableTariffs = [];
        
        // Ждем загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка авторизации при загрузке страницы
            fetch('/api/auth/check-status.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.authorized || data.status !== 'approved') {
                        // Не авторизован или не одобрен - редирект
                        window.location.href = '/';
                        return;
                    }
                    
                    // Проверяем роль для отображения админ панели
                    if (data.role === 'admin') {
                        console.log('Пользователь - админ, показываем админ панель');
                        document.querySelectorAll('.admin-only').forEach(el => {
                            el.style.display = 'flex';
                        });
                    }
                    
                    // Сохраняем данные пользователя
                    window.currentUser = {
                        id: data.id || null,
                        email: data.email,
                        role: data.role,
                        name: data.name
                    };
                    
                    // Загружаем список тарифов
                    loadTariffs();
                })
                .catch(error => {
                    console.error('Ошибка проверки авторизации:', error);
                    window.location.href = '/';
                });

            // Обработка выхода
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите выйти?')) {
                    fetch('/api/auth/logout.php')
                        .then(() => {
                            window.location.href = '/';
                        });
                }
            });

            // Переключение между секциями
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Убираем активный класс со всех пунктов
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    // Добавляем активный класс текущему
                    this.classList.add('active');
                    
                    // Скрываем все секции
                    document.querySelectorAll('.content-section').forEach(sec => {
                        sec.style.display = 'none';
                        sec.classList.remove('active');
                    });
                    
                    // Показываем нужную секцию
                    const targetSection = document.getElementById(`${section}-section`);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        targetSection.classList.add('active');
                        
                        // Если открываем раздел продуктов, загружаем тарифы для редактирования
                        if (section === 'products' && window.currentUser?.role === 'admin') {
                            loadTariffsForEdit();
                        }
                    }
                });
            });
        });

        // Функция загрузки тарифов для калькулятора
        async function loadTariffs() {
            try {
                const response = await fetch('/api/tariffs/list.php');
                const data = await response.json();
                
                if (data.success) {
                    window.availableTariffs = data.tariffs;
                    const select = document.getElementById('tariffSelect');
                    select.innerHTML = '';
                    
                    data.tariffs.forEach(tariff => {
                        const option = document.createElement('option');
                        option.value = tariff.id;
                        option.textContent = `${tariff.name} (${tariff.year})`;
                        if (tariff.is_default) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    // Загружаем данные выбранного тарифа
                    if (select.value) {
                        await loadTariffData(select.value);
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки тарифов:', error);
            }
        }

        // Функция загрузки данных конкретного тарифа
        async function loadTariffData(tariffId) {
            try {
                const response = await fetch(`/api/tariffs/get.php?id=${tariffId}`);
                const data = await response.json();
                
                if (data.success) {
                    window.currentTariff = data.tariff;
                    // Обновляем категории продуктов в интерфейсе
                    if (typeof updateProductCategories === 'function') {
                        updateProductCategories();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки данных тарифа:', error);
            }
        }

        // Обработчик изменения тарифа
        document.getElementById('tariffSelect')?.addEventListener('change', function() {
            if (this.value) {
                loadTariffData(this.value);
            }
        });
    </script>

    <!-- Удаляем data.js так как данные теперь в БД -->
    <!-- <script src="js/data.js"></script> -->
    <script src="js/script.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/products.js"></script>
</body>
</html>